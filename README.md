# CVE-2020-0022

Seems like Android 9-6 have similar Bluetooth subsystem, Android 5 and 4 are different.

Android 9.0

BlueFrag  experiments

Patch:

https://android.googlesource.com/platform/system/bt/+/3cb7149d8fed2d7d77ceaa95bf845224c4db3baf


Below I hit the patched condition. OK I think I got it, but somehow I cannot crash the process.

hmmmm

![BlueFrag](bluefrag-android.png)

Actually, managed to get signed length value to memcpy()

```
02-16 01:44:49.096  6423  6471 W bt_hci_packet_fragmenter: reassemble_and_dispatch reassemble_and_dispatch
02-16 01:44:49.096  6423  6471 W bt_hci_packet_fragmenter: reassemble_and_dispatch partial_packet->offset 40 packet->len 304 HCI_ACL_PREAMBLE_SIZE 4  
02-16 01:44:49.096  6423  6471 W bt_hci_packet_fragmenter: reassemble_and_dispatch projected_offset 340 partial_packet->len 41  
02-16 01:44:49.096  6423  6471 W bt_hci_packet_fragmenter: reassemble_and_dispatch got packet which would exceed expected length of 41. Truncating.
02-16 01:44:49.096  6423  6471 W bt_hci_packet_fragmenter: reassemble_and_dispatch memcpy packet->len 1 packet->offset 4 expr -3  
02-16 01:44:49.096  6423  6471 W bt_hci_packet_fragmenter: reassemble_and_dispatch partial_packet->data 0xacb14580 partial_packet->data + partial_packet->offset 0xacb145a8  packet->data 0xa553e110 packet->data + packet->offset 0xa553e114  
02-16 01:44:49.097  6423  6469 W bt_hci_packet_fragmenter: fragment_and_dispatch fragment_and_dispatch
```

Still no crash, but should.....


In the example above, with a memcpy size of -3, this value is interpreted as an unsigned integer (4294967293) and the memcpy continues until there is a page fault due to unmapped memory and the process should terminate.

My phone in 32 bits, maybe that's why. Mobile is Samsung S3 Neo+. Using jemalloc at least at Android 9.0 tests.


```
¯\_(ツ)_/¯
```

Well it looks correctly 

![GDB](gdb-session.png)
![log](log.png)
![memcpy](memcpy.png)


I suspect you have to open many connections (for some time) and somehow allocate a lot of memory before it crashes.

We are pushing here 4294967293 almost 4GB

```
¯\_(ツ)_/¯
```

Swing and leommxj found this weird behavior of Android 8:

https://translate.google.com/translate?hl=en&sl=auto&tl=en&u=https%3A%2F%2Fbestwing.me%2FAndroid-8.1-memcpy-func.html
(Translated from Chineese)

It possibly also affect Android 9. Will check it.

Android 8.1.0

```
01-01 02:35:50.429  1496  1594 D bt_btif_dm: remote version info [00:1a:7d:da:71:13]: 0, 0, 0
01-01 02:35:50.430  1496  1594 E BluetoothRemoteDevices: aclStateChangeCallback: device is NULL, address=00:1A:7D:DA:71:13, newState=0
01-01 02:35:50.475  1496  1765 W bt_hci_packet_fragmenter: reassemble_and_dispatch got packet which would exceed expected length of 209. Truncating.
01-01 02:35:50.476  1496  1945 W bt_l2cap: L2CAP - Invalid MTU Size
01-01 02:35:50.478  1496  1765 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
01-01 02:35:50.482  1496  1765 W bt_hci_packet_fragmenter: reassemble_and_dispatch found l2cap full length 201 less than the hci length 683.
01-01 02:35:50.482  1496  1945 W bt_l2cap: L2CAP - bad length in pkt. Exp: 201  Act: 675
01-01 02:35:50.484  1496  1765 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
01-01 02:35:50.487  1496  1765 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
01-01 02:35:50.490  1496  1765 W bt_hci_packet_fragmenter: reassemble_and_dispatch found l2cap full length 201 less than the hci length 683.
01-01 02:35:50.491  1496  1945 W bt_l2cap: L2CAP - bad length in pkt. Exp: 201  Act: 675
01-01 02:35:50.493  1496  1765 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
01-01 02:35:52.576  1496  1945 I bt_btm_sec: btm_sec_disconnected clearing pending flag handle:3 reason:19
```

Android 7.1.2

```
12-31 13:13:53.209  2820  2855 W bt_hci_packet_fragmenter: reassemble_and_dispatch found l2cap full length 201 less than the hci length 683.
12-31 13:13:53.209  2820  2878 W bt_l2cap: L2CAP - bad length in pkt. Exp: 201  Act: 675
12-31 13:13:53.214  2820  2855 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
12-31 13:13:53.217  2820  2855 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
12-31 13:13:53.221  2820  2855 W bt_hci_packet_fragmenter: reassemble_and_dispatch found l2cap full length 201 less than the hci length 683.
12-31 13:13:53.221  2820  2878 W bt_l2cap: L2CAP - bad length in pkt. Exp: 201  Act: 675
12-31 13:13:53.223  2820  2855 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
12-31 13:13:53.231  2820  2855 W bt_hci_packet_fragmenter: reassemble_and_dispatch got packet which would exceed expected length of 209. Truncating.
12-31 13:13:53.231  2820  2878 W bt_l2cap: L2CAP - Invalid MTU Size
12-31 13:13:53.233  2820  2855 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
```


Android 6.0.1

```
01-01 01:09:12.828  4314  4340 E BluetoothRemoteDevices: aclStateChangeCallback: Device is NULL
01-01 01:09:12.839  4314  4455 W bt_hci_packet_fragmenter: reassemble_and_dispatch got packet which would exceed expected length of 209. Truncating.
01-01 01:09:12.839  4314  4456 W bt_l2cap: L2CAP - Invalid MTU Size
01-01 01:09:12.841  4314  4455 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
01-01 01:09:12.847  4314  4455 W bt_hci_packet_fragmenter: reassemble_and_dispatch got packet which would exceed expected length of 209. Truncating.
01-01 01:09:12.847  4314  4456 W bt_l2cap: L2CAP ignoring duplicate echo request (1)
01-01 01:09:12.847  4314  4456 W bt_l2cap: L2CAP - Invalid MTU Size
01-01 01:09:12.850  4314  4455 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
01-01 01:09:12.854  4314  4455 E bt_hci_packet_fragmenter: reassemble_and_dispatch Invalid L2cap length : 201 :return .
01-01 01:09:12.856  4314  4455 W bt_hci_packet_fragmenter: reassemble_and_dispatch got continuation for unknown packet. Dropping it.
01-01 01:09:14.931  4314  4456 I bt_btm_sec: btm_sec_disconnected clearing pending flag handle:1 reason:19
01-01 01:09:14.931  4314  4456 W bt_l2cap: L2CA_SetDesireRole() new:x0, disallow_switch:0
01-01 01:09:14.931  4314  4340 E BluetoothRemoteDevices: aclStateChangeCallback: Device is NULL
```



Android 5.1.1
```
E/bt_mct  ( 2413): Unable to acquire buffer for incoming HCI message.
E/bt_mct  ( 2413): Invalid L2CAP Con't Packet: return NULL 
E/bt_mct  ( 2413): Unable to acquire buffer for incoming HCI message.
W/bt_mct  ( 2413): dropping incomplete ACL frame
```


Android 4.3

```
E/bt_h4   ( 6647): H4 - ACL frames reassembly failed:
E/bt_h4   ( 6647): 	 Total length of all segmented packets exceeds	 the original PDU length [CID:0x0001].
W/bt_h4   ( 6647): H4 - dropping invalid ACL frames
E/bt_h4   ( 6647): H4: Unable to acquire buffer for incoming HCI message.




E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: GKI_exception(): Task State Table
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [0] task name [BTU] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [1] task name [BTIF] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [2] task name [A2DP-MEDIA] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: GKI_exception 65535 Send - Buffer corrupted#####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: 
E/GKI_LINUX( 6647): ********************************************************************
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: * GKI_exception(): 65535 Send - Buffer corrupted
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: ********************************************************************
E/GKI_LINUX( 6647): #####
E/bt_h4   ( 6647): H4: Unable to acquire buffer for incoming HCI message.
D/IOP_DB_BT( 6647): db_query_create: id EnforceMasterRole :: key KEY_BDADDR, value 00:1a:7d:da:71:13
D/IOP_DB_BT( 6647): db_query_add_key: key KEY_LMP_MFCT, value 10
D/IOP_DB_BT( 6647): db_query_add_key: key KEY_LMP_VER, value 6:8891
D/IOP_DB_BT( 6647): db_query_add_key: key KEY_DIR_ALL, value *
E/bt_h4   ( 6647): H4: Unable to acquire buffer for incoming HCI message.
D/IOP_DB_BT( 6647): db_query_execute: result 1
D/        ( 6647): remote version info [00:1a:7d:da:71:13]: 6, a, 22bb
D/BluetoothRemoteDevices( 6647): aclStateChangeCallback: State:Connected to Device:00:1A:7D:DA:71:13
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: GKI_exception(): Task State Table
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [0] task name [BTU] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [1] task name [BTIF] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [2] task name [A2DP-MEDIA] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: GKI_exception 65535 Send - Buffer corrupted#####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: 
E/GKI_LINUX( 6647): ********************************************************************
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: * GKI_exception(): 65535 Send - Buffer corrupted
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: ********************************************************************
E/GKI_LINUX( 6647): #####
E/bt_h4   ( 6647): H4: Unable to acquire buffer for incoming HCI message.
E/bt_h4   ( 6647): H4: Unable to acquire buffer for incoming HCI message.
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: GKI_exception(): Task State Table
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [0] task name [BTU] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [1] task name [BTIF] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: TASK ID [2] task name [A2DP-MEDIA] state [1]
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: GKI_exception 65535 Send - Buffer corrupted#####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: 
E/GKI_LINUX( 6647): ********************************************************************
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: * GKI_exception(): 65535 Send - Buffer corrupted
E/GKI_LINUX( 6647): #####
E/GKI_LINUX( 6647): ##### ERROR : GKI_exception: ********************************************************************
E/GKI_LINUX( 6647): #####
E/bt_h4   ( 6647): H4: Unable to acquire buffer for incoming HCI message.
D/BluetoothRemoteDevices( 6647): Remote Device name is: N20180019
D/KeyguardViewMediator( 2341): Received android.bluetooth.device.action.ACL_CONNECTED deviceClass = 268
V/BluetoothEventManager( 4184): Received android.bluetooth.device.action.NAME_CHANGED
D/BluetoothDevicePreference( 4184): Is my device connected::false
I/BluetoothDevicePreference( 4184): summaryResId else part
D/ProgressBar( 4184): setProgress = 0
D/ProgressBar( 4184): setProgress = 0, fromUser = false
D/ProgressBar( 4184): mProgress = 0mIndeterminate = false, mMin = 0, mMax = 100
D/AbsListView( 4184): unregisterIRListener() is called 
D/BluetoothNotiBroadcastReceiver( 4184): onReceive
D/ProgressBar( 4184): setProgress = 0
D/ProgressBar( 4184): setProgress = 0, fromUser = false
D/ProgressBar( 4184): mProgress = 0mIndeterminate = false, mMin = 0, mMax = 100
D/AbsListView( 4184): unregisterIRListener() is called 
D/SSRMv2:Monitor( 2341): SIOP:: AP = 300 (read only)
D/ProgressBar( 4184): setProgress = 0
D/ProgressBar( 4184): setProgress = 0, fromUser = false
D/ProgressBar( 4184): mProgress = 0mIndeterminate = false, mMin = 0, mMax = 100
D/AbsListView( 4184): unregisterIRListener() is called 
D/btif_config_util( 6647): btif_config_save_file(L181): in file name:/data/misc/bluedroid/bt_config.new
D/ProgressBar( 4184): setProgress = 0
D/ProgressBar( 4184): setProgress = 0, fromUser = false
D/ProgressBar( 4184): mProgress = 0mIndeterminate = false, mMin = 0, mMax = 100
D/AbsListView( 4184): unregisterIRListener() is called 
D/IOP_DB_BT( 6647): db_query_create: id DisablePwlCtrReq :: key KEY_BDADDR, value 00:1a:7d:da:71:13
D/IOP_DB_BT( 6647): db_query_add_key: key KEY_LMP_MFCT, value 10
D/IOP_DB_BT( 6647): db_query_add_key: key KEY_LMP_VER, value 6:8891
D/IOP_DB_BT( 6647): db_query_add_key: key KEY_DIR_ALL, value *
D/IOP_DB_BT( 6647): db_query_execute: result 1
D/BluetoothRemoteDevices( 6647): aclStateChangeCallback: State:DisConnected to Device:00:1A:7D:DA:71:13
V/BluetoothEventManager( 4184): Received android.bluetooth.device.action.ACL_DISCONNECTED
E/BluetoothEventManager( 4184): ACTION_ACL_DISCONNECTED
D/BleAutoConnectService( 6647): android.bluetooth.device.action.ACL_DISCONNECTED
D/BleAutoConnectService( 6647): ACTION_ACL_DISCONNECTED, reason is 19linktype is 1
I/NfcService( 2661): android.bluetooth.device.action.ACL_DISCONNECTED, restart
D/BleAutoConnectService( 6647): getAddress() - address ==> null
D/KeyguardViewMediator( 2341): Received android.bluetooth.device.action.ACL_DISCONNECTED connectedBTforSmartLock = false
I/NfcService( 2661): Disabling NFC
D/NfcService( 2661): updateState : newSate = 4 mState = 4
D/BluetoothDevicePreference( 4184): Is my device connected::false
I/BluetoothDevicePreference( 4184): summaryResId else part
I/SecNdefService( 2661): enableDisable(sendEnable=false,receiveEnable=false)
I/SecNdefService( 2661): stopSecNdefService()size=1
I/SecNdefService( 2661): stopServer() : SAP(21).
E/NdefPushServer( 2661): IO error
E/NdefPushServer( 2661): java.io.IOException
E/NdefPushServer( 2661): 	at com.android.nfc.dhimpl.NativeLlcpServiceSocket.accept(NativeLlcpServiceSocket.java:42)
E/NdefPushServer( 2661): 	at com.android.nfc.ndefpush.NdefPushServer$ServerThread.run(NdefPushServer.java:160)
E/SnepServer( 2661): IO error
E/SnepServer( 2661): java.io.IOException
E/SnepServer( 2661): 	at com.android.nfc.dhimpl.NativeLlcpServiceSocket.accept(NativeLlcpServiceSocket.java:42)
E/SnepServer( 2661): 	at com.android.nfc.snep.SnepServer$ServerThread.run(SnepServer.java:211)
E/SnepServer( 2661): IO error
E/SnepServer( 2661): java.io.IOException
E/SnepServer( 2661): 	at com.android.nfc.dhimpl.NativeLlcpServiceSocket.accept(NativeLlcpServiceSocket.java:42)
E/SnepServer( 2661): 	at com.android.nfc.snep.SnepServer$ServerThread.run(SnepServer.java:211)
E/HandoverServer( 2661): IO error
E/HandoverServer( 2661): java.io.IOException
E/HandoverServer( 2661): 	at com.android.nfc.dhimpl.NativeLlcpServiceSocket.accept(NativeLlcpServiceSocket.java:42)
E/HandoverServer( 2661): 	at com.android.nfc.handover.HandoverServer$ServerThread.run(HandoverServer.java:108)
I/SecNdefService( 2661): Stop SendThread
E/NFCJNI  ( 2661): phLibNfc_SE_SetMode() returned 0x0095[NFCSTATUS_INVALID_HANDLE]
D/NfcService( 2661): NFC-C ON
D/ProgressBar( 4184): setProgress = 0
D/ProgressBar( 4184): setProgress = 0, fromUser = false
D/ProgressBar( 4184): mProgress = 0mIndeterminate = false, mMin = 0, mMax = 100
D/AbsListView( 4184): unregisterIRListener() is called 
D/ProgressBar( 4184): setProgress = 0
D/ProgressBar( 4184): setProgress = 0, fromUser = false
D/ProgressBar( 4184): mProgress = 0mIndeterminate = false, mMin = 0, mMax = 100
D/AbsListView( 4184): unregisterIRListener() is called 
D/NFCJNI  ( 2661): Terminating client thread...
D/NFCJNI  ( 2661): phLibNfc_Mgt_UnConfigureDriver() returned 0x0000[NFCSTATUS_SUCCESS]
D/NfcService( 2661): updateState : newSate = 1 mState = 1
D/ProgressBar( 4184): setProgress = 0
D/ProgressBar( 4184): setProgress = 0, fromUser = false
D/ProgressBar( 4184): mProgress = 0mIndeterminate = false, mMin = 0, mMax = 100
D/AbsListView( 4184): unregisterIRListener() is called 
D/[SBeam] ( 4184): SBeamEnabler.saveSbeamOn : false
```

